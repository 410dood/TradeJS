version: '3.3'

services:
  mongodb:
    image: mongo:latest
    container_name: "mongodb"
    environment:
      - MONGO_DATA_DIR=/data/db
      - MONGO_LOG_DIR=/dev/null
    volumes:
      - ./data/db:/data/db
    ports:
      - 27017:27017
    command: mongod --smallfiles --logpath=/dev/null # --quiet
    # deploy:
    #   mode: global
    #   restart_policy:
    #     condition: on-failure
    #   update_config:
    #     parallelism: 1
    #     delay: 1m30s
  cache:
    restart: unless-stopped
    image: cache
    container_name: "cache"
    build:
      context: ./
      dockerfile: server-cache/Dockerfile
    ports:
      - "3001"
    volumes:
      - ./server-cache:/usr/src/app/server-cache
      # - /usr/src/app/server-cache/node_modules
    links:
      - nginx
      - redis
      - mongodb
    command:
      - /bin/sh
      - -c
      - |
          npm i
          npm start
  nginx:
    restart: unless-stopped
    build: ./server-nginx
    image: nginx
    container_name: nginx
    ports:
      - "80:80"
    volumes:
      - ./images:/usr/src/images
  redis:
    restart: unless-stopped
    image: "redis:alpine"
    ports:
        - "6379"
    container_name: redis
  gateway:
    restart: unless-stopped
    image: mhart/alpine-node:8.9.4
    container_name: gateway
    build:
      context: ./
      dockerfile: ./server-gateway/Dockerfile
    ports:
      - "3100"
    volumes:
      - ./client:/usr/src/app/client
      - ./images:/usr/src/app/images
      - ./server-gateway:/usr/src/app/server-gateway
      # - ./server-gateway/node_modules:/usr/src/app/server-gateway/node_modules
    links:
      - nginx
      - redis
      - client
    command:
      - /bin/sh
      - -c
      - |
          npm i
          npm start
  client:
    image: client
    container_name: client
    build:
      context: ./
      dockerfile: /client/Dockerfile
    volumes:
      - ./client:/usr/src/app/client
    command:
      - /bin/sh
      - -c
      - |
          npm i
          npm start
  user:
    image: user
    container_name: user
    build:
      context: ./
      dockerfile: server-user/Dockerfile
    ports:
      - "3008"
    volumes:
      - ./server-user:/usr/src/app/server-user
      - /usr/src/app/server-user/node_modules
    links:
      - nginx
      - redis
      - mongodb
  notify:
    image: notify
    container_name: notify
    build:
      context: ./
      dockerfile: server-notify/Dockerfile
    ports:
      - "3010"
    volumes:
      - ./server-notify:/usr/src/app/server-notify
      - /usr/src/app/server-notify/node_modules
    links:
      - nginx
      - redis
      - mongodb
  comment:
    image: comment
    container_name: comment
    build:
      context: ./
      dockerfile: server-comment/Dockerfile
    ports:
      - "3009"
    volumes:
      - ./server-comment:/usr/src/app/server-comment
      - /usr/src/app/server-comment/node_modules
    links:
      - nginx
      - redis
      - mongodb
  event:
    image: event
    container_name: event
    build:
      context: ./
      dockerfile: server-event/Dockerfile
    ports:
      - "3011"
    volumes:
      - ./server-event:/usr/src/app/server-event
      - ./shared/modules/coinpush:/usr/src/app/shared/modules/coinpush
    links:
      - nginx
      - redis
      - mongodb
    command:
      - /bin/sh
      - -c
      - |
          npm i
          npm start